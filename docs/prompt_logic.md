
## 開発者向けドキュメント: プロンプト生成ロジック (docs/prompt_logic.md 草案)

```markdown
# プロンプト生成ロジック解説 (Project Wannabe 内部仕様)

このドキュメントは、Project Wannabe アプリケーション内部で、ユーザーの操作とUIの状態に応じて、KoboldCpp APIに送信する最終的なプロンプト文字列がどのように組み立てられるかを解説します。

**参照コード:** `src/core/prompt_builder.py`

## 1. 基本的な流れ

ユーザーが「生成開始」(F5キーまたはメニュー) をトリガーすると、以下のステップでプロンプトが生成されます。

1.  **タスク判定:** 現在のUI状態（選択中のモードタブ、本文エリアの入力有無、詳細情報タブの入力有無）に基づいて、実行すべき内部タスクタイプを決定します。
2.  **Instruction 選択:** 決定されたタスクタイプに対応する固定Instructionテンプレートを選択します。
3.  **Input 生成:** UIから必要な情報を取得し、タスクタイプに応じた形式で内部的なInput文字列を生成します。
4.  **最終プロンプト整形:** InstructionとInputを、ターゲットモデル（wanabi 24B）が学習したMistral形式のテンプレートに合わせて結合し、最終的なプロンプト文字列を生成します。

## 2. タスク判定ロジック

以下の条件分岐により、内部タスクタイプが決定されます。

| 選択中のモード | 本文エリアの状態 | 詳細情報タブの状態 | 決定されるタスクタイプ | 使用Instructionテンプレート |
| :------------- | :--------------- | :----------------- | :--------------------- | :------------------------ |
| **小説生成**   | 空               | **入力あり**       | `GEN_INFO`             | `GEN["with_input"]`       |
| **小説生成**   | 空               | 入力なし           | `GEN_ZERO`             | `GEN["no_input"]`        |
| **小説生成**   | **入力あり**     | **入力あり**       | `CONT_INFO`            | `CONT["with_input"]`      |
| **小説生成**   | **入力あり**     | 入力なし           | `CONT_ZERO`            | `CONT["no_input"]`       |
| **アイデア出し** | (不問)           | **入力あり**       | `IDEA_INFO`            | `IDEA["with_input"]`      |
| **アイデア出し** | (不問)           | 入力なし           | `IDEA_ZERO`            | `IDEA["no_input"]`       |

**補足:**

*   「詳細情報タブの状態」は、タイトル、キーワード、ジャンル、あらすじ、設定、プロットのいずれか1つ以上にユーザーが入力しているかどうかで判定されます。
*   「アイデア出し」モードでは、本文エリアの状態はタスク判定に影響しません。

## 3. 固定Instructionテンプレート

以下のテンプレートが `src/core/prompt_builder.py` 内に直接定義されています。

```python
INSTRUCTION_TEMPLATES = {
    "GEN": {
        "with_input": "以下の情報に基づいて小説本文を生成してください。",
        "no_input": "自由に小説を生成してください。"
    },
    "CONT": {
        "with_input": "参考情報を基に以下の文章の続きを生成してください。",
        "no_input": "以下の文章の続きを生成してください。"
    },
    "IDEA": {
        "with_input": "以下の情報に基づいて、完全な小説のアイデア（タイトル、キーワード、ジャンル、あらすじ、設定、プロット）を生成してください。",
        "no_input": "自由に小説のアイデア（タイトル、キーワード、ジャンル、あらすじ、設定、プロット）を生成してください。"
    }
}
```

## 4. Input文字列の生成

タスクタイプに応じて、以下のルールで内部Input文字列 (`internal_input`) が生成されます。

*   **`GEN_INFO` / `GEN_ZERO` / `IDEA_INFO` / `IDEA_ZERO` タスクの場合:**
    1.  右側の詳細情報タブから、入力されている全メタデータ (`title`, `keywords`, `genres`, `synopsis`, `setting`, `plot`) を取得します。
    2.  取得したメタデータ項目を `METADATA_MAP` で定義された**固定の順序**（タイトル→キーワード→ジャンル→あらすじ→設定→プロット）で、以下の形式で結合します。
        ```
        # {日本語名1}:
        {値1}

        # {日本語名2}:
        {値2}
        ...
        ```
    3.  値のフォーマット:
        *   キーワード (`keywords`) とジャンル (`genres`) は、リスト形式で取得し、各要素を改行 (`\n`) で区切って文字列化します (`"\n".join(value)`)。
        *   その他の項目はそのまま文字列として使用します。
    4.  入力がない場合 (`GEN_ZERO`, `IDEA_ZERO`)、`internal_input` は空文字列 (`""`) になります。
    5.  **注意:** `IDEA` タスクの場合でも、キーワード欠損処理は**行いません**。ユーザーが入力したものがそのまま使われます。

*   **`CONT_INFO` / `CONT_ZERO` タスクの場合:**
    1.  左上の本文表示エリアのテキスト (`main_text`) を**そのまま全て**取得します。テキストの分割は行いません。
    2.  `CONT_INFO` の場合は、上記と同様に詳細情報タブからメタデータを取得し、`metadata_input_string` を生成します。
    3.  最終的な `internal_input` を以下の形式で組み立てます。
        ```
        【本文】
        ```
        {main_text 全体}
        ```
        {metadata_input_string が存在する場合のみ、以下を追加}
        【参考情報】
        ```
        {metadata_input_string}
        ```
        ```
    4.  `CONT_ZERO` の場合は、`metadata_input_string` がないため、`【参考情報】...` の部分は追加されません。

## 5. 最終プロンプト整形 (Mistral形式)

最後に、選択された `instruction_text` と生成された `internal_input` を、以下のように結合して KoboldCpp に送信する `prompt` 文字列を生成します。

```python
if internal_input:
    prompt = f"<s>[INST] {instruction_text}\n\n{internal_input} [/INST]"
else:
    # Input が空の場合
    prompt = f"<s>[INST] {instruction_text} [/INST]"
```

*   `<s>` と `[/INST]` の間のスペースや改行は、モデルの学習データに合わせて調整されている想定です。
*   システムプロンプト (`[SYSTEM_PROMPT]...`) は使用しません。
*   応答 (`<assistant response>`) は `[/INST]` の後に続くことを期待します。

## 6. ストップシーケンス

ユーザーが設定画面で指定したストップシーケンス (`stop_sequences` リスト) は、KoboldCpp APIリクエスト時の `stop_sequence` パラメータに渡されます。デフォルト値は `["[INST]", "[/INST]"]` です。これにより、モデルが不要なテンプレート文字列を生成した場合などに、そこで生成が停止されます。
